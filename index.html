<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pokédex</title>
</head>
<body>
  <main id="pokemon"></main>
  <script src="https://unpkg.com/babel-standalone/babel.js"></script>
  <script src="https://unpkg.com/react/dist/react.js"></script>
  <script src="https://unpkg.com/react-dom/dist/react-dom.js"></script>
  <script src="https://unpkg.com/react-dom-factories/index.js"></script>
  <script src="https://unpkg.com/prop-types/prop-types.js"></script>
  <script type="text/babel">
    function Loading() {
      return (
        <h3>loading</h3>
      );
    }

    function Error(props) {
      return(
        <p>Pokémon {props.detail}</p>
      );
    }

    function PokemonDisplay(props) {
      return (
        <figure>
          <PokemonIMG name={props.name} image={props.image} />
          <PokemonName name={props.name} />
        </figure>
      );
    }

    function PokemonTypes(props) {
      return(
        <ul>
          {props.types
            .map((type, index) => <PokemonType type={type.type.name} key={index} />)
          }
        </ul>
      );
    }

    function PokemonType(props) {
      return(
        <li>{props.type}</li>
      );
    }

    function PokemonIMG(props) {
      return (
        <img src={props.image} alt={props.name} />
      );
    }

    function PokemonName(props) {
      return (
        <figcaption>{props.name}</figcaption>
      );
    }

    function Button(props) {
      return(
        <button id={props.id}>{props.legend}</button>
      );
    }

    function PokemonAbilities(props) {
      return (
        <ul>
          {props.abilities
            .map((ability, index) => <PokemonAbility ability={ability.ability.name} key={index} />)
          }
        </ul>
      );
    }

    function PokemonAbility(props) {
      return(
        <li>{props.ability}</li>
      );
    }

    function PokemonMoves(props) {
      return (
        <ul>
          {props.moves
            .map((move, index) => <PokemonMove move={move.move.name} key={index} />)
          }
        </ul>
      );
    }

    function PokemonMove(props) {
      return(
        <li>{props.move}</li>
      );
    }

    class Pokemon extends React.Component {
      constructor(props) {
        super(props);

        this.state = {
          loading: true,
          id: 1,
          name: '',
          image: '',
          types: [],
          level: 0,
          abilities: [],
          moves: [],
          error: '',
        };

        this.handleClick = this.handleClick.bind(this);
        this.handleSearch = this.handleSearch.bind(this);
      };

      componentWillMount() {
        this.getPokemon(this.state.id);
      }

      componentDidMount() {
        // document.getElementById('prev').addEventListener('click', this.handleClick);
        // document.getElementById('next').addEventListener('click', this.handleClick);
      };

      render(){
        if (this.state.loading) {
          return(
            <Loading />
          );
        }

        return (
          <section>
            {this.state.error &&
              <Error detail={this.state.error} />
            }
            <h1>{this.props.title}</h1>
            <PokemonDisplay name={this.state.name} image={this.state.image} />
            <h2>Tipo:</h2>
            <PokemonTypes types={this.state.types} />
            <Button id={this.props.prev} legend={this.props.prevName} onClick={this.handleClick} />
            <form method="GET">
              <input type="text" id="pokemonID" placeholder="Escribe el ID del Pokémon que quieres buscar" />
              <button type="submit" id="submit" onClick={this.handleSearch}>Buscar</button>
            </form>
            <Button id={this.props.next} legend={this.props.nextName} onClick={this.handleClick} />
            <h3>{this.props.abilitiesTitle}</h3>
            <PokemonAbilities abilities={this.state.abilities} />
            <h4>{this.props.movesTitle}</h4>
            <PokemonMoves moves={this.state.moves} />
          </section>
        );
      };

      componentWillUnmount() {
        // document.getElementById('prev').removeEventListener('click');
        // document.getElementById('next').removeEventListener('click');
      }

      handleClick = (event) => {
        event.preventDefault();
        console.log('click');

        let pokemonID = (event.target.id == 'prev') ? this.state.id-- : this.state.id++;
        pokemonID = (pokemonID <= 0) ? 1 : pokemonID;

        this.getPokemon(pokemonID);
      }

      handleSearch = (event) => {
        event.preventDefault();
        let pokemonID = document.getElementById('pokemonID').value;

        console.log(pokemonID);
        this.getPokemon(pokemonID);
      }

      async getPokemon(id=null) {
        const pokemonID = id || this.state.id;

        this.setState({
          loading: true,
        });

        try {
          const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonID}/`);
          const pokemon = await response.json();
          if (pokemon.detail) {
            this.setState((prevState) => {
              return {
                loading: false,
                error: pokemon.detail,
              };
            });

            return false;
          }

          console.log( pokemon );
          this.setState((prevState) => {
            return {
              loading: false,
              id: pokemon.id,
              name: pokemon.name,
              image: pokemon.sprites.front_default,
              types: pokemon.types,
              level: pokemon.base_experience,
              abilities: pokemon.abilities,
              moves: pokemon.moves,
            };
          });
        } catch (e) {
          this.setState((prevState) => {
            return {
              loading: false,
              error: pokemon.detail,
            };
          });
        }
      }
    }

    Pokemon.defaultProps = {
      loading: true,
      title: 'Nombre del Pokémon',
      prev: 'prev',
      next: 'next',
      prevName: 'Anterior',
      nextName: 'Siguiente',
      abilitiesTitle: 'Habilidades disponibles',
      movesTitle: 'Movimientos disponibles',
    }

    Pokemon.propTypes = {
      loading: PropTypes.bool,
      id: PropTypes.number,
      name: PropTypes.string,
      image: PropTypes.string,
      types: PropTypes.arrayOf(PropTypes.object),
      level: PropTypes.number,
      abilities: PropTypes.arrayOf(PropTypes.object),
      moves: PropTypes.arrayOf(PropTypes.object),
      prev: PropTypes.string,
      next: PropTypes.string,
      prevName: PropTypes.string,
      nextName: PropTypes.string,
      error: PropTypes.string,
    };

    ReactDOM.render(
      <Pokemon />,
      document.getElementById('pokemon')
    );
  </script>
</body>
</html>
