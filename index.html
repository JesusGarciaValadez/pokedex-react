<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pokédex</title>
</head>
<body>
  <main id="pokemon"></main>
  <script src="https://unpkg.com/babel-standalone/babel.js"></script>
  <script src="https://unpkg.com/react/dist/react.js"></script>
  <script src="https://unpkg.com/react-dom/dist/react-dom.js"></script>
  <script src="https://unpkg.com/react-dom-factories/index.js"></script>
  <script src="https://unpkg.com/prop-types/prop-types.js"></script>
  <script type="text/babel">
    function PokemonDisplay(props) {
      return (
        <figure>
          <PokemonIMG name={props.name} image={props.image} />
          <PokemonName name={props.name} />
        </figure>
      );
    }

    function PokemonIMG(props) {
      return (
        <img src={props.image} alt={props.name} />
      );
    }

    function PokemonName(props) {
      return (
        <figcaption>{props.name}</figcaption>
      );
    }

    function Button(props) {
      return(
        <button id={props.id}>{props.legend}</button>
      );
    }

    function PokemonAbilities(props) {
      return (
        <ul>
          {props.abilities
            .map((ability, index) => <PokemonAbility ability={ability.ability.name} key={index} />)
          }
        </ul>
      );
    }

    function PokemonAbility(props) {
      return(
        <li>{props.ability}</li>
      );
    }

    function PokemonMoves(props) {
      return (
        <ul>
          {props.moves
            .map((move, index) => <PokemonMove move={move.move.name} key={index} />)
          }
        </ul>
      );
    }

    function PokemonMove(props) {
      return(
        <li>{props.move}</li>
      );
    }

    class Pokemon extends React.Component {
      constructor(props) {
        super(props);

        this.state = {
          id: 1,
          name: "",
          image: "",
          level: 0,
          abilities: [],
          moves: [],
          error: true,
        };

        this.handleClick = this.handleClick.bind(this);
        this.handleNumber = this.handleNumber.bind(this);
      };

      componentDidMount() {
        this.getPokemon(this.state.id);

        document.getElementById('prev').addEventListener('click', this.handleClick);
        document.getElementById('next').addEventListener('click', this.handleClick);

        document.getElementById('pokemonID').addEventListener('change', this.handleNumber);
      };

      render(){
        return (
          <section>
            <h1>{this.props.title}</h1>
            <PokemonDisplay name={this.state.name} image={this.state.image} />
            <Button id={this.props.prev} legend={this.props.prevName} />
            <input type="text" name="pokemonID" id="pokemonID" placeholder="Escribe el ID del Pokémon que quieres buscar" onChange={this.handleNumber} />
            <Button id={this.props.next} legend={this.props.nextName} />
            <h2>{this.props.abilitiesTitle}</h2>
            <PokemonAbilities abilities={this.state.abilities} />
            <h3>{this.props.movesTitle}</h3>
            <PokemonMoves moves={this.state.moves} />
          </section>
        );
      };

      componentWillUnmount() {
        document.getElementById('prev').removeEventListener('click');
        document.getElementById('next').removeEventListener('click');
        document.getElementById('pokemonID').removeEventListener('change');
      }

      handleClick = (event) => {
        event.preventDefault();

        let pokemonID = (event.target.id == 'prev') ? this.state.id-- : this.state.id++;
        pokemonID = (pokemonID <= 0) ? 1 : pokemonID;

        this.getPokemon(pokemonID);
      }

      handleNumber = (event) => {
        event.preventDefault();
        let pokemonID = event.currentTarget.value;

        console.log(pokemonID);
        this.getPokemon(pokemonID);
      }

      async getPokemon(id=null) {
        const pokemonID = id || this.state.id;

        try {
          const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonID}/`);
          const pokemon = await response.json();

          console.log( pokemon );
          this.setState((prevState) => {
            return {
              id: pokemon.id,
              name: pokemon.name,
              image: pokemon.sprites.front_default,
              level: pokemon.base_experience,
              abilities: pokemon.abilities,
              moves: pokemon.moves,
            };
          });
        } catch (e) {
          this.setState((prevState) => {
            return {
              error: true,
            };
          });
        } finally {

        }
      }
    }

    Pokemon.defaultProps = {
      title: 'Nombre del Pokémon',
      prev: 'prev',
      next: 'next',
      prevName: 'Siguiente',
      nextName: 'Anterior',
      abilitiesTitle: 'Habilidades disponibles',
      movesTitle: 'Movimientos disponibles',
    }

    Pokemon.propTypes = {
      id: PropTypes.number,
      name: PropTypes.string,
      image: PropTypes.string,
      level: PropTypes.number,
      abilities: PropTypes.arrayOf(PropTypes.object),
      moves: PropTypes.arrayOf(PropTypes.object),
      prev: PropTypes.string,
      next: PropTypes.string,
      prevName: PropTypes.string,
      nextName: PropTypes.string,
    };

    ReactDOM.render(
      <Pokemon />,
      document.getElementById('pokemon')
    );
  </script>
</body>
</html>
